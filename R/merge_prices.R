#' Merge REMIND-derived fuel prices with non-fuel costs.
#'
#' @param gdx path to REMIND binary output, gdx format
#' @param REMINDmapping mapping of REMIND regions to ISO3 country codes
#' @param REMINDyears range of REMIND timesteps
#' @param intensity_data logit level intensity data
#' @param nonfuel_costs logti level non-fuel costs
#' @param module GDX input is based on old "complex" module or new "edge_esm" module
#' @import data.table
#' @importFrom rmndt disaggregate_dt magpie2dt
#' @importFrom gdx readGDX
#' @importFrom magclass time_interpolate lowpass dimSums mbind
#' @importFrom magrittr `%>%`
#' @export

merge_prices <- function(gdx, REMINDmapping, REMINDyears,
                         intensity_data,
                         nonfuel_costs,
                         module="edge_esm") {
    sector_fuel <- ttot <- value <- fuel_price <- fuel_price_pkm <- EJ_Mpkm_final <- NULL
    non_fuel_price <- technology <- GDP_cap <- region <- `.` <- weight <- POP_val <- NULL
    GDP <- `elect_td_trn` <- time <- `Liquids-Electricity` <- `refined liquids enduse` <- NULL
    vehicle_type <- subsector_L3 <- subsector_L2 <- subsector_L1 <- sector <- tot_price <- NULL
    ## report prices from REMIND gdx in 2005$/MJ

    tdptwyr2dpgj <- 31.71  #TerraDollar per TWyear to Dollar per GJ
    CONV_2005USD_1990USD <- 0.67
    startyear <- 2020
    years <- REMINDyears[REMINDyears >= startyear]
    ## load entries from the gdx, values below 2020 do not make sense
    pfe <- readGDX(gdx, "pm_FEPrice", format = "first_found", restore_zeros = FALSE)[, years, "trans.ES", pmatch=TRUE]
    ## smooth prices
    pfe <- pfe %>% lowpass() %>% magpie2dt()
    pfe[
      , year := as.numeric(ttot)][
      , value := value * tdptwyr2dpgj][ # 2005$ per GJ
      , c("sector", "emiMkt", "ttot") := NULL
    ]
    pfe <- approx_dt(pfe, c(1990, seq(2005, startyear - 5, 5), unique(pfe$year)),
                     xcol="year", ycol="value", idxcols=c("all_regi", "all_enty"), extrapolate=TRUE)
    setnames(pfe, "all_regi", "region")
    varmap <- fread(text="
all_enty,sector_fuel
fedie,refined liquids enduse
fepet,refined liquids enduse
fegat,delivered gas
feelt,elect_td_trn
feh2t,H2 enduse
")
    pfe <- varmap[pfe, on="all_enty"][, .(value=mean(value)), by=c("region", "year", "sector_fuel")]

    test <- pfe[year > 2005 & value <= 1]

    if(nrow(test)){
        print(paste("Fuel prices lower than 1$/GJ found. Regions:", unique(test$region)))
        print("The weighted averages of non-zero regions of the corresponding fuel will be used.")
        pfe[, value := ifelse(value <= 1, mean(value[value>1]), value), by = c("year", "sector_fuel")]
    }

    ## hybrids price from electricity and liquids
    pfe <- pfe %>%
      dcast(...~sector_fuel) %>%
      .[, `Liquids-Electricity` := 0.6*`refined liquids enduse` + 0.4 * `elect_td_trn`] %>%
      melt(id.vars=c("region", "year"), variable.name="sector_fuel")

    setnames(pfe, old = c("value"), new = c("fuel_price"))

    ## fuel price in 2005USD/GJ -> 1990USD/EJ
    pfe[, fuel_price := fuel_price * CONV_2005USD_1990USD * 1e9]

    ## join with vehicle intensity and load factor to get the 1990USD/pkm
    fuel_price_REMIND <- merge(pfe, intensity_data, by = c("region",
        "year", "sector_fuel"), all.y = TRUE)

    ## fuel_price [$/EJ * EJ/Mpkm * Mpkm/pkm],
    tech_cost <- fuel_price_REMIND[, fuel_price_pkm := fuel_price * EJ_Mpkm_final * 1e-6]

    ## merge the non energy prices, they are $/pkm
    tech_cost <- merge(tech_cost, nonfuel_costs,
                        by = c("region", "year", "technology",
                               "vehicle_type", "subsector_L1",
                               "subsector_L2", "subsector_L3","sector"),
                        all.x = TRUE)

    ## calculate the total price
    tech_cost[, tot_price := fuel_price_pkm + non_fuel_price]

    return(tech_cost)

}
